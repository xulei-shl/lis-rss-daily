<%- include('layout', { pageTitle: pageTitle, pageStyles: '', body: `
<style>
  .settings-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .section-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .rss-sources-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
  }

  .rss-sources-table th,
  .rss-sources-table td {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .rss-sources-table th {
    background: var(--bg);
    font-weight: 600;
    color: var(--dim);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rss-sources-table tr:last-child td {
    border-bottom: none;
  }

  .rss-sources-table td {
    font-size: 0.9rem;
  }

  .rss-name {
    font-weight: 500;
  }

  .rss-url {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .rss-url a {
    color: var(--dim);
  }

  .rss-url a:hover {
    color: var(--accent);
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.active {
    background: rgba(42, 157, 110, 0.15);
    color: var(--green);
  }

  .status-badge.inactive {
    background: rgba(231, 76, 60, 0.15);
    color: var(--red);
  }

  .action-buttons {
    display: flex;
    gap: 6px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--dim);
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .validation-result {
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    display: none;
  }

  .validation-result.valid {
    display: block;
    background: rgba(42, 157, 110, 0.15);
    color: var(--green);
  }

  .validation-result.invalid {
    display: block;
    background: rgba(231, 76, 60, 0.15);
    color: var(--red);
  }

  .validation-result.checking {
    display: block;
    color: var(--dim);
  }

  .fetch-interval-select {
    width: auto;
    min-width: 150px;
  }
</style>

<div class="settings-container">
  <div class="section-header">
    <h2>RSS 订阅源</h2>
    <button class="btn btn-primary" onclick="showAddModal()">+ 添加订阅源</button>
  </div>

  <table class="rss-sources-table" id="rssSourcesTable">
    <thead>
      <tr>
        <th>名称</th>
        <th>URL</th>
        <th>状态</th>
        <th>抓取间隔</th>
        <th>最后抓取</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="rssSourcesBody">
      <!-- 动态加载 -->
    </tbody>
  </table>

  <div id="emptyState" class="empty-state" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11c3.87 0 7 3.13 7 7M6 17a1 1 0 100 2 1 1 0 000-2z" />
    </svg>
    <p>暂无 RSS 订阅源</p>
    <p style="font-size: 0.9rem; margin-top: 8px;">点击上方按钮添加您的第一个订阅源</p>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="sourceModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">添加 RSS 订阅源</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <form id="sourceForm">
      <input type="hidden" id="sourceId">
      <div class="form-group">
        <label for="sourceName">名称 *</label>
        <input type="text" id="sourceName" required placeholder="例如: ArXiv CS.AI">
      </div>
      <div class="form-group">
        <label for="sourceUrl">URL *</label>
        <input type="url" id="sourceUrl" required placeholder="https://arxiv.org/rss/cs.AI">
        <div id="validationResult" class="validation-result"></div>
      </div>
      <div class="form-group">
        <label for="fetchInterval">抓取间隔</label>
        <select id="fetchInterval" class="fetch-interval-select">
          <option value="3600">1 小时</option>
          <option value="7200">2 小时</option>
          <option value="14400">4 小时</option>
          <option value="21600">6 小时</option>
          <option value="43200">12 小时</option>
          <option value="86400">24 小时</option>
        </select>
      </div>
      <div class="form-group">
        <label for="sourceStatus">状态</label>
        <select id="sourceStatus">
          <option value="active">启用</option>
          <option value="inactive">禁用</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<script>
let rssSources = [];

// Load RSS sources on page load
loadRSSSources();

async function loadRSSSources() {
  try {
    const res = await fetch('/api/rss-sources');
    const data = await res.json();
    rssSources = data.sources || [];
    renderTable();
  } catch (err) {
    console.error('Failed to load RSS sources:', err);
  }
}

function renderTable() {
  const tbody = document.getElementById('rssSourcesBody');
  const emptyState = document.getElementById('emptyState');
  const table = document.getElementById('rssSourcesTable');

  if (rssSources.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  tbody.innerHTML = rssSources.map(source => \`
    <tr>
      <td class="rss-name">\${escapeHtml(source.name)}</td>
      <td class="rss-url">
        <a href="\${escapeHtml(source.url)}" target="_blank" rel="noopener" title="\${escapeHtml(source.url)}">
          \${escapeHtml(truncate(source.url, 35))}
        </a>
      </td>
      <td>
        <span class="status-badge \${source.status}">\${source.status === 'active' ? '启用' : '禁用'}</span>
      </td>
      <td>\${formatInterval(source.fetch_interval)}</td>
      <td>\${formatDate(source.last_fetched_at)}</td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon" onclick="editSource(\${source.id})">编辑</button>
          <button class="btn-icon" onclick="fetchNow(\${source.id})">抓取</button>
          <button class="btn-icon" onclick="deleteSource(\${source.id})">删除</button>
        </div>
      </td>
    </tr>
  \`).join('');
}

function showAddModal() {
  document.getElementById('modalTitle').textContent = '添加 RSS 订阅源';
  document.getElementById('sourceId').value = '';
  document.getElementById('sourceName').value = '';
  document.getElementById('sourceUrl').value = '';
  document.getElementById('fetchInterval').value = '3600';
  document.getElementById('sourceStatus').value = 'active';
  document.getElementById('validationResult').className = 'validation-result';
  document.getElementById('validationResult').textContent = '';
  document.getElementById('sourceModal').classList.add('active');
  document.getElementById('sourceName').focus();
}

function editSource(id) {
  const source = rssSources.find(s => s.id === id);
  if (!source) return;

  document.getElementById('modalTitle').textContent = '编辑 RSS 订阅源';
  document.getElementById('sourceId').value = source.id;
  document.getElementById('sourceName').value = source.name;
  document.getElementById('sourceUrl').value = source.url;
  document.getElementById('fetchInterval').value = source.fetch_interval.toString();
  document.getElementById('sourceStatus').value = source.status;
  document.getElementById('validationResult').className = 'validation-result';
  document.getElementById('validationResult').textContent = '';
  document.getElementById('sourceModal').classList.add('active');
}

function closeModal() {
  document.getElementById('sourceModal').classList.remove('active');
}

// URL validation
let validationTimeout;
document.getElementById('sourceUrl').addEventListener('input', function() {
  clearTimeout(validationTimeout);
  const url = this.value.trim();
  const resultDiv = document.getElementById('validationResult');

  if (!url || !url.startsWith('http')) {
    resultDiv.className = 'validation-result';
    resultDiv.textContent = '';
    return;
  }

  validationTimeout = setTimeout(async () => {
    resultDiv.className = 'validation-result checking';
    resultDiv.textContent = '正在验证...';

    try {
      const res = await fetch('/api/rss-sources/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await res.json();

      if (data.valid) {
        resultDiv.className = 'validation-result valid';
        resultDiv.textContent = \`✓ \${data.feedTitle || '有效 RSS 源'} (\${data.itemCount || 0} 条目)\`;
      } else {
        resultDiv.className = 'validation-result invalid';
        resultDiv.textContent = \`✗ \${data.error || '无法验证 RSS 源'}\`;
      }
    } catch (err) {
      resultDiv.className = 'validation-result invalid';
      resultDiv.textContent = '✗ 验证失败，请稍后重试';
    }
  }, 500);
});

// Form submit
document.getElementById('sourceForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id = document.getElementById('sourceId').value;
  const data = {
    name: document.getElementById('sourceName').value.trim(),
    url: document.getElementById('sourceUrl').value.trim(),
    fetchInterval: parseInt(document.getElementById('fetchInterval').value),
    status: document.getElementById('sourceStatus').value
  };

  try {
    const url = id ? \`/api/rss-sources/\${id}\` : '/api/rss-sources';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      closeModal();
      loadRSSSources();
    } else {
      const result = await res.json();
      alert(result.error || '保存失败');
    }
  } catch (err) {
    alert('保存失败，请稍后重试');
  }
});

async function deleteSource(id) {
  if (!confirm('确定要删除这个 RSS 订阅源吗？')) return;

  try {
    const res = await fetch(\`/api/rss-sources/\${id}\`, { method: 'DELETE' });
    if (res.ok) {
      loadRSSSources();
    } else {
      const result = await res.json();
      alert(result.error || '删除失败');
    }
  } catch (err) {
    alert('删除失败，请稍后重试');
  }
}

async function fetchNow(id) {
  try {
    const res = await fetch(\`/api/rss-sources/\${id}/fetch\`, { method: 'POST' });
    const result = await res.json();
    alert(result.message || '抓取任务已加入队列');
  } catch (err) {
    alert('操作失败，请稍后重试');
  }
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function truncate(str, len) {
  if (!str) return '';
  if (str.length <= len) return str;
  return str.substring(0, len - 3) + '...';
}

function formatInterval(seconds) {
  if (seconds < 3600) return \`\${Math.floor(seconds / 60)} 分钟\`;
  if (seconds < 86400) return \`\${Math.floor(seconds / 3600)} 小时\`;
  return \`\${Math.floor(seconds / 86400)} 天\`;
}

function formatDate(dateStr) {
  if (!dateStr) return '从未';
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return '刚刚';
  if (diff < 3600000) return \`\${Math.floor(diff / 60000)} 分钟前\`;
  if (diff < 86400000) return \`\${Math.floor(diff / 3600000)} 小时前\`;

  return date.toLocaleDateString('zh-CN', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Close modal on overlay click
document.getElementById('sourceModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeModal();
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeLLMModal();
  }
});
</script>

<style>
.llm-section {
  max-width: 1200px;
  margin: 40px auto 0;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.llm-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--surface);
  border-radius: 8px;
  overflow: hidden;
}

.llm-table th,
.llm-table td {
  text-align: left;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.llm-table th {
  background: var(--bg);
  font-weight: 600;
  color: var(--dim);
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.llm-provider {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.type-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  background: rgba(26, 77, 122, 0.12);
  color: var(--accent);
}

.provider-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.provider-badge.openai {
  background: rgba(16, 163, 127, 0.15);
  color: #10a37f;
}

.provider-badge.gemini {
  background: rgba(66, 133, 244, 0.15);
  color: #4285f4;
}

.provider-badge.custom {
  background: rgba(107, 114, 128, 0.15);
  color: var(--dim);
}

.default-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  background: rgba(251, 191, 36, 0.15);
  color: #f59e0b;
  margin-left: 8px;
}

.llm-model {
  font-family: monospace;
  font-size: 0.9rem;
  color: var(--dim);
}

.api-key-masked {
  font-family: monospace;
  color: var(--dim);
  letter-spacing: 2px;
}

.test-result {
  margin-top: 8px;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 0.85rem;
  display: none;
}

.test-result.success {
  display: block;
  background: rgba(42, 157, 110, 0.15);
  color: var(--green);
}

.test-result.error {
  display: block;
  background: rgba(231, 76, 60, 0.15);
  color: var(--red);
}

.test-result.testing {
  display: block;
  color: var(--dim);
}

.chroma-section {
  max-width: 1200px;
  margin: 40px auto 0;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.chroma-form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.chroma-form .form-group {
  margin-bottom: 0;
}

.chroma-actions {
  grid-column: 1 / -1;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 8px;
}

.chroma-status {
  margin-top: 12px;
  font-size: 0.85rem;
  color: var(--dim);
}

@media (max-width: 768px) {
  .chroma-form {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- LLM Configs Section -->
<div class="llm-section">
  <div class="section-header">
    <h2>LLM 配置</h2>
    <button class="btn btn-primary" onclick="showLLMAddModal()">+ 添加 LLM 配置</button>
  </div>

  <table class="llm-table" id="llmConfigsTable">
    <thead>
      <tr>
        <th>提供商</th>
        <th>类型</th>
        <th>模型</th>
        <th>Base URL</th>
        <th>API 密钥</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="llmConfigsBody">
      <!-- 动态加载 -->
    </tbody>
  </table>

  <div id="llmEmptyState" class="empty-state" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
    <p>暂无 LLM 配置</p>
    <p style="font-size: 0.9rem; margin-top: 8px;">点击上方按钮添加您的第一个 LLM 配置</p>
  </div>
</div>

<!-- Chroma Settings Section -->
<div class="chroma-section">
  <div class="section-header">
    <h2>Chroma 设置</h2>
  </div>
  <form id="chromaForm" class="chroma-form">
    <div class="form-group">
      <label for="chromaHost">Host</label>
      <input type="text" id="chromaHost" placeholder="127.0.0.1">
    </div>
    <div class="form-group">
      <label for="chromaPort">Port</label>
      <input type="number" id="chromaPort" min="1" max="65535" placeholder="8000">
    </div>
    <div class="form-group">
      <label for="chromaCollection">Collection</label>
      <input type="text" id="chromaCollection" placeholder="articles">
    </div>
    <div class="form-group">
      <label for="chromaMetric">距离度量</label>
      <select id="chromaMetric">
        <option value="cosine">cosine</option>
        <option value="l2">l2</option>
        <option value="ip">ip</option>
      </select>
    </div>
    <div class="chroma-actions">
      <button type="submit" class="btn btn-primary">保存</button>
    </div>
  </form>
  <div id="chromaStatus" class="chroma-status"></div>
</div>

<!-- Add/Edit LLM Config Modal -->
<div class="modal-overlay" id="llmConfigModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="llmModalTitle">添加 LLM 配置</h3>
      <button class="modal-close" onclick="closeLLMModal()">&times;</button>
    </div>
    <form id="llmConfigForm">
      <input type="hidden" id="llmConfigId">
      <div class="form-group">
        <label for="llmConfigType">配置类型 *</label>
        <select id="llmConfigType" required onchange="updateConfigTypeUI()">
          <option value="llm">LLM</option>
          <option value="embedding">Embedding</option>
          <option value="rerank">Rerank</option>
        </select>
      </div>
      <div class="form-group">
        <label for="llmProvider">提供商 *</label>
        <select id="llmProvider" required onchange="updateProviderDefaults()">
          <option value="openai">OpenAI</option>
          <option value="gemini">Google Gemini</option>
          <option value="custom">自定义</option>
        </select>
      </div>
      <div class="form-group">
        <label for="llmBaseURL">Base URL *</label>
        <input type="url" id="llmBaseURL" required placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1">
      </div>
      <div class="form-group">
        <label for="llmApiKey">API 密钥 *</label>
        <input type="password" id="llmApiKey" required placeholder="sk-...">
      </div>
      <div class="form-group">
        <label for="llmModel">模型 *</label>
        <input type="text" id="llmModel" required placeholder="gpt-4o-mini" value="gpt-4o-mini">
      </div>
      <div class="form-group">
        <label for="llmTimeout">超时时间 (毫秒)</label>
        <input type="number" id="llmTimeout" min="1000" value="30000">
      </div>
      <div class="form-group">
        <label for="llmMaxRetries">最大重试次数</label>
        <input type="number" id="llmMaxRetries" min="0" value="3">
      </div>
      <div class="form-group">
        <label for="llmIsDefault">设为默认</label>
        <input type="checkbox" id="llmIsDefault">
      </div>
      <div class="form-group" id="rerankEnabledGroup" style="display: none;">
        <label for="llmRerankEnabled">启用重排序</label>
        <input type="checkbox" id="llmRerankEnabled">
      </div>
      <div id="llmTestResult" class="test-result"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="testLLMConnection()">测试连接</button>
        <button type="button" class="btn btn-secondary" onclick="closeLLMModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<script>
let llmConfigs = [];

// Load LLM configs on page load
loadLLMConfigs();

async function loadLLMConfigs() {
  try {
    const res = await fetch('/api/llm-configs');
    const data = await res.json();
    llmConfigs = data.configs || [];
    renderLLMTable();
  } catch (err) {
    console.error('Failed to load LLM configs:', err);
  }
}

function renderLLMTable() {
  const tbody = document.getElementById('llmConfigsBody');
  const emptyState = document.getElementById('llmEmptyState');
  const table = document.getElementById('llmConfigsTable');

  if (llmConfigs.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  tbody.innerHTML = llmConfigs.map(config => \`
    <tr>
      <td>
        <div class="llm-provider">
          <span class="provider-badge \${config.provider}">\${config.provider}</span>
          \${config.is_default ? '<span class="default-badge">默认</span>' : ''}
        </div>
      </td>
      <td><span class="type-badge">\${config.config_type || 'llm'}</span></td>
      <td><span class="llm-model">\${escapeHtml(config.model)}</span></td>
      <td><span class="rss-url">\${escapeHtml(truncate(config.base_url, 35))}</span></td>
      <td><span class="api-key-masked">\${config.has_api_key ? '••••••••' : '未设置'}</span></td>
      <td>\${config.config_type === 'rerank' ? (config.enabled ? '启用' : '禁用') : '-'}</td>
      <td>
        <div class="action-buttons">
          \${!config.is_default ? '<button class="btn-icon" onclick="setDefaultLLMConfig(' + config.id + ')">设为默认</button>' : ''}
          <button class="btn-icon" onclick="editLLMConfig(\${config.id})">编辑</button>
          <button class="btn-icon" onclick="deleteLLMConfig(\${config.id})">删除</button>
        </div>
      </td>
    </tr>
  \`).join('');
}

function showLLMAddModal() {
  document.getElementById('llmModalTitle').textContent = '添加 LLM 配置';
  document.getElementById('llmConfigId').value = '';
  document.getElementById('llmConfigType').value = 'llm';
  document.getElementById('llmProvider').value = 'openai';
  document.getElementById('llmBaseURL').value = 'https://api.openai.com/v1';
  document.getElementById('llmApiKey').value = '';
  document.getElementById('llmModel').value = 'gpt-4o-mini';
  document.getElementById('llmTimeout').value = '30000';
  document.getElementById('llmMaxRetries').value = '3';
  document.getElementById('llmIsDefault').checked = llmConfigs.length === 0;
  document.getElementById('llmRerankEnabled').checked = false;
  document.getElementById('llmTestResult').className = 'test-result';
  document.getElementById('llmTestResult').textContent = '';
  updateConfigTypeUI();
  document.getElementById('llmConfigModal').classList.add('active');
  document.getElementById('llmConfigType').focus();
}

function editLLMConfig(id) {
  const config = llmConfigs.find(c => c.id === id);
  if (!config) return;

  document.getElementById('llmModalTitle').textContent = '编辑 LLM 配置';
  document.getElementById('llmConfigId').value = config.id;
  document.getElementById('llmConfigType').value = config.config_type || 'llm';
  document.getElementById('llmProvider').value = config.provider;
  document.getElementById('llmBaseURL').value = config.base_url;
  document.getElementById('llmApiKey').value = '';
  document.getElementById('llmModel').value = config.model;
  document.getElementById('llmTimeout').value = config.timeout;
  document.getElementById('llmMaxRetries').value = config.max_retries;
  document.getElementById('llmIsDefault').checked = config.is_default === 1;
  document.getElementById('llmRerankEnabled').checked = config.enabled === 1;
  document.getElementById('llmTestResult').className = 'test-result';
  document.getElementById('llmTestResult').textContent = '';
  updateConfigTypeUI();
  document.getElementById('llmConfigModal').classList.add('active');
}

function closeLLMModal() {
  document.getElementById('llmConfigModal').classList.remove('active');
}

function updateProviderDefaults() {
  const configType = document.getElementById('llmConfigType').value;
  const provider = document.getElementById('llmProvider').value;
  const baseURLInput = document.getElementById('llmBaseURL');
  const modelInput = document.getElementById('llmModel');

  switch (provider) {
    case 'openai':
      baseURLInput.value = 'https://api.openai.com/v1';
      if (configType === 'llm') {
        modelInput.value = 'gpt-4o-mini';
      }
      break;
    case 'gemini':
      baseURLInput.value = 'https://generativelanguage.googleapis.com/v1beta';
      if (configType === 'llm') {
        modelInput.value = 'gemini-1.5-flash';
      }
      break;
    case 'custom':
      baseURLInput.value = '';
      if (configType === 'llm') {
        modelInput.value = '';
      }
      break;
  }
}

function updateConfigTypeUI() {
  const configType = document.getElementById('llmConfigType').value;
  const rerankGroup = document.getElementById('rerankEnabledGroup');
  const rerankCheckbox = document.getElementById('llmRerankEnabled');

  if (configType === 'rerank') {
    rerankGroup.style.display = 'block';
  } else {
    rerankGroup.style.display = 'none';
    rerankCheckbox.checked = false;
  }
}

async function testLLMConnection() {
  const resultDiv = document.getElementById('llmTestResult');
  resultDiv.className = 'test-result testing';
  resultDiv.textContent = '正在测试连接...';

  const id = document.getElementById('llmConfigId').value;
  const data = {
    configType: document.getElementById('llmConfigType').value,
    provider: document.getElementById('llmProvider').value,
    baseURL: document.getElementById('llmBaseURL').value,
    apiKey: document.getElementById('llmApiKey').value,
    model: document.getElementById('llmModel').value,
    enabled: document.getElementById('llmRerankEnabled').checked,
  };

  try {
    let res;
    if (id) {
      // Test existing config
      res = await fetch(\`/api/llm-configs/\${id}/test\`, { method: 'POST' });
    } else {
      // Create temporary config for testing
      res = await fetch('/api/llm-configs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...data,
          isDefault: false,
        }),
      });

      if (res.ok) {
        const result = await res.json();
        const testRes = await fetch(\`/api/llm-configs/\${result.id}/test\`, { method: 'POST' });
        // Clean up test config
        await fetch(\`/api/llm-configs/\${result.id}\`, { method: 'DELETE' });

        const testData = await testRes.json();
        if (testData.success) {
          resultDiv.className = 'test-result success';
          resultDiv.textContent = '✓ 连接成功';
        } else {
          resultDiv.className = 'test-result error';
          resultDiv.textContent = \`✗ 连接失败: \${testData.error}\`;
        }
        return;
      }
    }

    const testData = await res.json();
    if (testData.success) {
      resultDiv.className = 'test-result success';
      resultDiv.textContent = '✓ 连接成功';
    } else {
      resultDiv.className = 'test-result error';
      resultDiv.textContent = \`✗ 连接失败: \${testData.error}\`;
    }
  } catch (err) {
    resultDiv.className = 'test-result error';
    resultDiv.textContent = '✗ 测试失败，请稍后重试';
  }
}

document.getElementById('llmConfigForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id = document.getElementById('llmConfigId').value;
  const data = {
    configType: document.getElementById('llmConfigType').value,
    provider: document.getElementById('llmProvider').value,
    baseURL: document.getElementById('llmBaseURL').value,
    apiKey: document.getElementById('llmApiKey').value,
    model: document.getElementById('llmModel').value,
    timeout: parseInt(document.getElementById('llmTimeout').value),
    maxRetries: parseInt(document.getElementById('llmMaxRetries').value),
    isDefault: document.getElementById('llmIsDefault').checked,
    enabled: document.getElementById('llmRerankEnabled').checked,
  };

  try {
    const url = id ? \`/api/llm-configs/\${id}\` : '/api/llm-configs';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (res.ok) {
      closeLLMModal();
      loadLLMConfigs();
    } else {
      const result = await res.json();
      alert(result.error || '保存失败');
    }
  } catch (err) {
    alert('保存失败，请稍后重试');
  }
});

async function deleteLLMConfig(id) {
  if (!confirm('确定要删除这个 LLM 配置吗？')) return;

  try {
    const res = await fetch(\`/api/llm-configs/\${id}\`, { method: 'DELETE' });
    if (res.ok) {
      loadLLMConfigs();
    } else {
      const result = await res.json();
      alert(result.error || '删除失败');
    }
  } catch (err) {
    alert('删除失败，请稍后重试');
  }
}

async function setDefaultLLMConfig(id) {
  try {
    const res = await fetch(\`/api/llm-configs/\${id}/set-default\`, { method: 'POST' });
    if (res.ok) {
      loadLLMConfigs();
    } else {
      const result = await res.json();
      alert(result.error || '设置失败');
    }
  } catch (err) {
    alert('设置失败，请稍后重试');
  }
}

document.getElementById('llmConfigModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeLLMModal();
  }
});

// Chroma settings
loadChromaSettings();

async function loadChromaSettings() {
  try {
    const res = await fetch('/api/settings/chroma');
    const data = await res.json();
    document.getElementById('chromaHost').value = data.host || '127.0.0.1';
    document.getElementById('chromaPort').value = data.port || 8000;
    document.getElementById('chromaCollection').value = data.collection || 'articles';
    document.getElementById('chromaMetric').value = data.distanceMetric || 'cosine';
  } catch (err) {
    setChromaStatus('加载失败，请稍后重试');
  }
}

function setChromaStatus(message) {
  const el = document.getElementById('chromaStatus');
  el.textContent = message || '';
}

document.getElementById('chromaForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const payload = {
    host: document.getElementById('chromaHost').value.trim(),
    port: parseInt(document.getElementById('chromaPort').value),
    collection: document.getElementById('chromaCollection').value.trim(),
    distanceMetric: document.getElementById('chromaMetric').value,
  };

  try {
    const res = await fetch('/api/settings/chroma', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (res.ok) {
      setChromaStatus('设置已保存');
    } else {
      const result = await res.json();
      setChromaStatus(result.error || '保存失败');
    }
  } catch (err) {
    setChromaStatus('保存失败，请稍后重试');
  }
});
</script>
` }) %>
