<%- include('layout', { pageTitle: pageTitle, pageStyles: '<link rel="stylesheet" href="/css/pages/search.css">' , body:
  ` <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">语义搜索</h1>
  </div>

  <!-- Search Box -->
  <div class="search-container">
    <div class="search-box">
      <input type="text" id="searchInput" class="search-input" placeholder="输入问题或关键词..." autocomplete="off">
      <button id="searchButton" class="search-button">搜索</button>
    </div>
    <p class="search-tips">
      提示: 尝试 <code>LLM 在代码生成中的应用</code> 或 <code>多智能体系统最新进展</code>
    </p>
  </div>

  <!-- Results Container -->
  <div id="resultsContainer">
    <!-- Initial State -->
    <div class="empty-state" id="initialState">
      <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <div class="empty-state-title">搜索文章</div>
      <div class="empty-state-desc">
        输入关键词或问题，查找相关的学术文章。<br>
        支持语义搜索和关键词匹配。
      </div>
    </div>

    <!-- Loading State (Hidden) -->
    <div class="loading" id="loadingState" style="display: none;">
      搜索中
    </div>

    <!-- Results Area (Hidden) -->
    <div id="resultsArea" style="display: none;">
      <div class="results-header">
        <div class="results-count" id="resultsCount"></div>
        <div class="results-query" id="resultsQuery"></div>
      </div>
      <div id="resultsList"></div>
      <div class="pagination" id="pagination" style="display: none;"></div>
    </div>

    <!-- No Results State (Hidden) -->
    <div class="empty-state" id="noResultsState" style="display: none;">
      <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div class="empty-state-title">未找到相关文章</div>
      <div class="empty-state-desc">
        尝试调整搜索词或使用更通用的关键词
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // SEARCH PAGE LOGIC
    // ============================================

    let currentQuery = '';
    let currentPage = 1;
    let totalPages = 1;
    const perPage = 10;
    let searchTimeout = null;

    // Load on page ready
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      const searchButton = document.getElementById('searchButton');

      // Focus search input
      searchInput.focus();

      // Search on Enter
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          performSearch();
        }
      });

      // Search on button click
      searchButton.addEventListener('click', performSearch);

      // Auto-search with debounce
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = searchInput.value.trim();

        if (query.length >= 2) {
          searchTimeout = setTimeout(() => {
            performSearch();
          }, 500);
        } else if (query.length === 0) {
          showInitialState();
        }
      });

      // Check for query in URL
      const urlParams = new URLSearchParams(window.location.search);
      const urlQuery = urlParams.get('q');
      if (urlQuery) {
        searchInput.value = urlQuery;
        performSearch();
      }
    });

    // Perform search
    async function performSearch(page = 1) {
      const searchInput = document.getElementById('searchInput');
      const query = searchInput.value.trim();

      if (!query) {
        showInitialState();
        return;
      }

      currentQuery = query;
      currentPage = page;

      // Update URL without reloading
      const url = new URL(window.location);
      url.searchParams.set('q', query);
      if (page > 1) url.searchParams.set('page', page);
      window.history.replaceState({}, '', url);

      // Show loading
      showLoading();

      try {
        const params = new URLSearchParams({
          q: query,
          page: currentPage,
          limit: perPage
        });

        const res = await fetch(\`/api/search?\${params}\`);
    const data = await res.json();

    if (data.results && data.results.length > 0) {
      showResults(data);
    } else {
      showNoResults();
    }
  } catch (err) {
    console.error('Search failed:', err);
    showNoResults();
  }
}

// Show initial state
function showInitialState() {
  hideAllStates();
  document.getElementById('initialState').style.display = 'block';
}

// Show loading state
function showLoading() {
  hideAllStates();
  document.getElementById('loadingState').style.display = 'block';
}

// Show results
function showResults(data) {
  hideAllStates();
  const resultsArea = document.getElementById('resultsArea');
  resultsArea.style.display = 'block';

  // Update results count
  const total = data.total || data.results.length;
  document.getElementById('resultsCount').textContent =
    \`找到 \${total} 篇相关文章\`;

  // Update query display
  document.getElementById('resultsQuery').innerHTML =
    \`搜索 <em>"\${escapeHtml(currentQuery)}"</em>\`;

  // Render results
  const resultsList = document.getElementById('resultsList');
  resultsList.innerHTML = data.results.map((result, index) =>
    renderSearchResult(result, index)
  ).join('');

  // Update pagination
  totalPages = Math.ceil((data.total || data.results.length) / perPage);
  renderPagination();
}

// Show no results
function showNoResults() {
  hideAllStates();
  document.getElementById('noResultsState').style.display = 'block';
}

// Hide all states
function hideAllStates() {
  document.getElementById('initialState').style.display = 'none';
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('resultsArea').style.display = 'none';
  document.getElementById('noResultsState').style.display = 'none';
}

// Render single search result
function renderSearchResult(result, index) {
  const relevance = result.relevance || result.score || 0;
  const scorePercent = Math.round(relevance * 100);

  let scoreClass = 'low';
  if (scorePercent >= 90) scoreClass = 'high';
  else if (scorePercent >= 70) scoreClass = 'medium';

  // Highlight matching terms in title and excerpt
  const highlightedTitle = highlightTerms(result.title, currentQuery);
  const highlightedExcerpt = highlightTerms(
    result.excerpt || result.summary || '',
    currentQuery
  );

  return \`
    <div class="search-result fade-in-up" style="animation-delay: \${index * 30}ms">
      <div class="search-result-header">
        <h3 class="search-result-title">
          <a href="/articles/\${result.id}">\${highlightedTitle}</a>
        </h3>
        <div class="relevance-score \${scoreClass}">
          相关度 \${scorePercent}%
        </div>
      </div>
      <div class="search-result-meta">
        <span>\${escapeHtml(result.rss_source_name || 'Unknown')}</span>
        <span>·</span>
        <span>\${formatTime(result.published_at)}</span>
        <span>·</span>
        <a href="\${escapeHtml(result.url)}" target="_blank" rel="noopener">原文</a>
      </div>
      \${highlightedExcerpt ? \`<div class="search-result-excerpt">\${highlightedExcerpt}</div>\` : ''}
      \${result.tags ? \`
        <div class="search-result-tags">
          \${result.tags.split(',').slice(0, 5).map(tag =>
            \`<span class="search-result-tag">#\${escapeHtml(tag.trim())}</span>\`
          ).join('')}
        </div>
      \` : ''}
    </div>
  \`;
}

// Highlight search terms in text
function highlightTerms(text, query) {
  if (!text) return '';
  if (!query) return escapeHtml(text);

  const escapedText = escapeHtml(text);
  const terms = query.split(/\\s+/).filter(t => t.length >= 2);

  if (terms.length === 0) return escapedText;

  // Create regex for all terms
  const pattern = new RegExp(\`(\${terms.map(t => escapeRegex(t)).join('|')})\`, 'gi');

  return escapedText.replace(pattern, '<mark>$1</mark>');
}

// Escape special regex characters
function escapeRegex(str) {
  return str.replace(/[.*+?^$()|[\\]\\\\]/g, '\\\\$&');
}

// Render pagination
function renderPagination() {
  const pagination = document.getElementById('pagination');

  if (totalPages <= 1) {
    pagination.style.display = 'none';
    return;
  }

  pagination.style.display = 'flex';

  let html = '';

  // Previous
  html += currentPage > 1
    ? \`<a href="#" onclick="goToPage(\${currentPage - 1}); return false;">← 上一页</a>\`
    : '<span>← 上一页</span>';

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += '<a href="#" onclick="goToPage(1); return false;">1</a>';
    if (startPage > 2) html += '<span>...</span>';
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += \`<span class="current">\${i}</span>\`;
    } else {
      html += \`<a href="#" onclick="goToPage(\${i}); return false;">\${i}</a>\`;
    }
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += \`<a href="#" onclick="goToPage(\${totalPages}); return false;">\${totalPages}</a>\`;
  }

  // Next
  html += currentPage < totalPages
    ? \`<a href="#" onclick="goToPage(\${currentPage + 1}); return false;">下一页 →</a>\`
    : '<span>下一页 →</span>';

  pagination.innerHTML = html;
}

// Go to page
function goToPage(page) {
  currentPage = page;
  performSearch(page);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatTime(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return '刚刚';
  if (diff < 3600000) return \`\${Math.floor(diff / 60000)} 分钟前\`;
  if (diff < 86400000) return \`\${Math.floor(diff / 3600000)} 小时前\`;

  return date.toLocaleDateString('zh-CN', {
    month: 'short',
    day: 'numeric',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
  });
}
  </script>
  ` }) %>