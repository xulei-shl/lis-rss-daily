<%- include('layout', { pageTitle: pageTitle, pageStyles: '', body: `
<style>
  .topics-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    max-width: 1400px;
  }

  .topics-panel {
    background: var(--surface);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid var(--border);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th,
  .data-table td {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }

  .data-table th {
    background: var(--bg);
    font-weight: 600;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .data-table tr:last-child td {
    border-bottom: none;
  }

  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.active {
    background: rgba(42, 157, 110, 0.15);
    color: var(--green);
  }

  .status-badge.inactive {
    background: rgba(231, 76, 60, 0.15);
    color: var(--red);
  }

  .action-buttons {
    display: flex;
    gap: 4px;
  }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--dim);
  }

  .empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .domain-description {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--dim);
  }

  .keyword-count {
    font-size: 0.75rem;
    color: var(--dim);
  }

  .keyword-domain-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    background: var(--bg);
    border-radius: 3px;
    color: var(--dim);
    white-space: nowrap;
  }

  textarea {
    min-height: 80px;
    resize: vertical;
  }

  @media (max-width: 900px) {
    .topics-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="topics-container">
  <!-- Domains Panel -->
  <div class="topics-panel">
    <div class="section-header">
      <h2>主题领域</h2>
      <button class="btn btn-primary" onclick="showDomainModal()">+ 添加领域</button>
    </div>

    <table class="data-table" id="domainsTable">
      <thead>
        <tr>
          <th>名称</th>
          <th>关键词数</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="domainsBody">
        <!-- Dynamic content -->
      </tbody>
    </table>

    <div id="domainsEmpty" class="empty-state" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
      </svg>
      <p>暂无主题领域</p>
    </div>
  </div>

  <!-- Keywords Panel -->
  <div class="topics-panel">
    <div class="section-header">
      <h2>关键词</h2>
      <button class="btn btn-primary" onclick="showKeywordModal()">+ 添加关键词</button>
    </div>

    <table class="data-table" id="keywordsTable">
      <thead>
        <tr>
          <th>关键词</th>
          <th>所属领域</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="keywordsBody">
        <!-- Dynamic content -->
      </tbody>
    </table>

    <div id="keywordsEmpty" class="empty-state" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
      </svg>
      <p>暂无关键词</p>
    </div>
  </div>

</div>

<!-- Domain Modal -->
<div class="modal-overlay" id="domainModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="domainModalTitle">添加主题领域</h3>
      <button class="modal-close" onclick="closeDomainModal()">&times;</button>
    </div>
    <form id="domainForm">
      <input type="hidden" id="domainId">
      <div class="form-group">
        <label for="domainName">名称 *</label>
        <input type="text" id="domainName" required placeholder="例如: 机器学习">
      </div>
      <div class="form-group">
        <label for="domainDescription">描述</label>
        <textarea id="domainDescription" placeholder="简要描述这个研究领域..."></textarea>
      </div>
      <div class="form-group">
        <label for="domainPriority">优先级</label>
        <input type="number" id="domainPriority" value="0" min="0" max="100" style="width: 100px;">
        <small style="color: var(--dim);">数值越大优先级越高</small>
      </div>
      <div class="form-group">
        <label for="domainActive">状态</label>
        <select id="domainActive">
          <option value="true">启用</option>
          <option value="false">禁用</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDomainModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<!-- Keyword Modal -->
<div class="modal-overlay" id="keywordModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="keywordModalTitle">添加关键词</h3>
      <button class="modal-close" onclick="closeKeywordModal()">&times;</button>
    </div>
    <form id="keywordForm">
      <input type="hidden" id="keywordId">
      <div class="form-group">
        <label for="keywordDomainId">所属领域 *</label>
        <select id="keywordDomainId" required>
          <option value="">请选择领域</option>
        </select>
      </div>
      <div class="form-group">
        <label for="keywordName">关键词 *</label>
        <input type="text" id="keywordName" required placeholder="例如: 深度学习">
      </div>
      <div class="form-group">
        <label for="keywordDescription">描述</label>
        <textarea id="keywordDescription" placeholder="简要描述这个关键词..."></textarea>
      </div>
      <div class="form-group">
        <label for="keywordWeight">权重</label>
        <input type="number" id="keywordWeight" value="1.0" min="0" max="10" step="0.1" style="width: 100px;">
        <small style="color: var(--dim);">0-10，数值越大权重越高</small>
      </div>
      <div class="form-group">
        <label for="keywordActive">状态</label>
        <select id="keywordActive">
          <option value="true">启用</option>
          <option value="false">禁用</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeKeywordModal()">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<script>
let domains = [];
let keywords = [];

// Load domains and keywords on page load
loadDomains();
loadKeywords();

async function loadDomains() {
  try {
    const res = await fetch('/api/topic-domains?limit=200');
    const data = await res.json();
    domains = data.domains || [];
    renderDomains();
    updateDomainSelect();
  } catch (err) {
    console.error('Failed to load domains:', err);
  }
}

async function loadKeywords() {
  try {
    const res = await fetch('/api/topic-keywords/all');
    keywords = await res.json() || [];
    renderKeywords();
  } catch (err) {
    console.error('Failed to load keywords:', err);
  }
}

function renderDomains() {
  const tbody = document.getElementById('domainsBody');
  const emptyState = document.getElementById('domainsEmpty');
  const table = document.getElementById('domainsTable');

  if (domains.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  tbody.innerHTML = domains.map(domain => \`
    <tr class="domain-row">
      <td>
        <div style="font-weight: 500;">\${escapeHtml(domain.name)}</div>
        \${domain.description ? \`<div class="domain-description">\${escapeHtml(domain.description)}</div>\` : ''}
      </td>
      <td>
        <span class="keyword-count">\${domain.keyword_count || 0} 个关键词</span>
      </td>
      <td>
        <span class="status-badge \${domain.is_active ? 'active' : 'inactive'}">
          \${domain.is_active ? '&#10003;' : '&#10007;'}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon" onclick="editDomain(\${domain.id})">&#9998;</button>
          <button class="btn-icon" onclick="deleteDomain(\${domain.id})">&#128465;</button>
        </div>
      </td>
    </tr>
  \`).join('');
}

function renderKeywords() {
  const tbody = document.getElementById('keywordsBody');
  const emptyState = document.getElementById('keywordsEmpty');
  const table = document.getElementById('keywordsTable');

  if (keywords.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  tbody.innerHTML = keywords.map(keyword => \`
    <tr class="keyword-row">
      <td>
        <div style="font-weight: 500;">\${escapeHtml(keyword.keyword)}</div>
        \${keyword.description ? \`<div class="domain-description">\${escapeHtml(keyword.description)}</div>\` : ''}
      </td>
      <td>
        <span class="keyword-domain-badge">\${escapeHtml(keyword.domain_name)}</span>
      </td>
      <td>
        <span class="status-badge \${keyword.is_active ? 'active' : 'inactive'}">
          \${keyword.is_active ? '&#10003;' : '&#10007;'}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn-icon" onclick="editKeyword(\${keyword.id})">&#9998;</button>
          <button class="btn-icon" onclick="deleteKeyword(\${keyword.id})">&#128465;</button>
        </div>
      </td>
    </tr>
  \`).join('');
}

function updateDomainSelect() {
  const select = document.getElementById('keywordDomainId');
  const currentValue = select.value;
  select.innerHTML = '<option value="">请选择领域</option>';
  domains.forEach(domain => {
    if (domain.is_active) {
      const option = document.createElement('option');
      option.value = domain.id;
      option.textContent = domain.name;
      select.appendChild(option);
    }
  });
  select.value = currentValue;
}

// Domain modal functions
function showDomainModal() {
  document.getElementById('domainModalTitle').textContent = '添加主题领域';
  document.getElementById('domainId').value = '';
  document.getElementById('domainName').value = '';
  document.getElementById('domainDescription').value = '';
  document.getElementById('domainPriority').value = '0';
  document.getElementById('domainActive').value = 'true';
  document.getElementById('domainModal').classList.add('active');
  document.getElementById('domainName').focus();
}

function editDomain(id) {
  const domain = domains.find(d => d.id === id);
  if (!domain) return;

  document.getElementById('domainModalTitle').textContent = '编辑主题领域';
  document.getElementById('domainId').value = domain.id;
  document.getElementById('domainName').value = domain.name;
  document.getElementById('domainDescription').value = domain.description || '';
  document.getElementById('domainPriority').value = domain.priority;
  document.getElementById('domainActive').value = domain.is_active ? 'true' : 'false';
  document.getElementById('domainModal').classList.add('active');
}

function closeDomainModal() {
  document.getElementById('domainModal').classList.remove('active');
}

// Keyword modal functions
function showKeywordModal() {
  if (domains.filter(d => d.is_active).length === 0) {
    showConfirm('请先添加并启用一个主题领域', {
      title: '提示',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
    return;
  }

  document.getElementById('keywordModalTitle').textContent = '添加关键词';
  document.getElementById('keywordId').value = '';
  document.getElementById('keywordDomainId').value = '';
  document.getElementById('keywordName').value = '';
  document.getElementById('keywordDescription').value = '';
  document.getElementById('keywordWeight').value = '1.0';
  document.getElementById('keywordActive').value = 'true';
  document.getElementById('keywordModal').classList.add('active');
  document.getElementById('keywordName').focus();
}

function editKeyword(id) {
  const keyword = keywords.find(k => k.id === id);
  if (!keyword) return;

  document.getElementById('keywordModalTitle').textContent = '编辑关键词';
  document.getElementById('keywordId').value = keyword.id;
  document.getElementById('keywordDomainId').value = keyword.domain_id;
  document.getElementById('keywordName').value = keyword.keyword;
  document.getElementById('keywordDescription').value = keyword.description || '';
  document.getElementById('keywordWeight').value = keyword.weight;
  document.getElementById('keywordActive').value = keyword.is_active ? 'true' : 'false';
  document.getElementById('keywordModal').classList.add('active');
}

function closeKeywordModal() {
  document.getElementById('keywordModal').classList.remove('active');
}

// Domain form submit
document.getElementById('domainForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id = document.getElementById('domainId').value;
  const data = {
    name: document.getElementById('domainName').value.trim(),
    description: document.getElementById('domainDescription').value.trim() || null,
    priority: parseInt(document.getElementById('domainPriority').value),
    isActive: document.getElementById('domainActive').value === 'true'
  };

  try {
    const url = id ? \`/api/topic-domains/\${id}\` : '/api/topic-domains';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      closeDomainModal();
      await loadDomains();
      await loadKeywords();
    } else {
      const result = await res.json();
      await showConfirm(result.error || '保存失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('保存失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
});

// Keyword form submit
document.getElementById('keywordForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const id = document.getElementById('keywordId').value;
  const data = {
    domainId: parseInt(document.getElementById('keywordDomainId').value),
    keyword: document.getElementById('keywordName').value.trim(),
    description: document.getElementById('keywordDescription').value.trim() || null,
    weight: parseFloat(document.getElementById('keywordWeight').value),
    isActive: document.getElementById('keywordActive').value === 'true'
  };

  try {
    const url = id ? \`/api/topic-keywords/\${id}\` : '/api/topic-keywords';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      closeKeywordModal();
      await loadDomains();
      await loadKeywords();
    } else {
      const result = await res.json();
      await showConfirm(result.error || '保存失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('保存失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
});

async function deleteDomain(id) {
  const domain = domains.find(d => d.id === id);
  const msg = domain ? \`确定要删除主题领域 "\${domain.name}" 吗？\\n\\n此操作将同时删除该领域下的所有关键词！\` : '确定要删除吗？';
  const confirmed = await showConfirm(msg, {
    title: '删除主题领域',
    okText: '删除',
    cancelText: '取消'
  });
  if (!confirmed) return;

  try {
    const res = await fetch(\`/api/topic-domains/\${id}\`, { method: 'DELETE' });
    if (res.ok) {
      await loadDomains();
      await loadKeywords();
    } else {
      const result = await res.json();
      await showConfirm(result.error || '删除失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('删除失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}

async function deleteKeyword(id) {
  const keyword = keywords.find(k => k.id === id);
  const msg = keyword ? \`确定要删除关键词 "\${keyword.keyword}" 吗？\` : '确定要删除吗？';
  const confirmed = await showConfirm(msg, {
    title: '删除关键词',
    okText: '删除',
    cancelText: '取消'
  });
  if (!confirmed) return;

  try {
    const res = await fetch(\`/api/topic-keywords/\${id}\`, { method: 'DELETE' });
    if (res.ok) {
      await loadDomains();
      await loadKeywords();
    } else {
      const result = await res.json();
      await showConfirm(result.error || '删除失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('删除失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Close modals on overlay click
document.getElementById('domainModal').addEventListener('click', function(e) {
  if (e.target === this) closeDomainModal();
});
document.getElementById('keywordModal').addEventListener('click', function(e) {
  if (e.target === this) closeKeywordModal();
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDomainModal();
    closeKeywordModal();
  }
});
</script>
` }) %>
