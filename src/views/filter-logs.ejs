<%- include('layout', { pageTitle: pageTitle, pageStyles: '', body: `
<style>
  .logs-container {
    max-width: 1200px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .section-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .filters {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filters label {
    font-size: 0.9rem;
    color: var(--dim);
  }

  .filters select {
    padding: 6px 12px;
    min-width: 120px;
  }

  .logs-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
  }

  .logs-table th,
  .logs-table td {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
  }

  .logs-table th {
    background: var(--bg);
    font-weight: 600;
    color: var(--dim);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .logs-table tr:last-child td {
    border-bottom: none;
  }

  .logs-table tr.expanded {
    background: var(--bg);
  }

  .article-title {
    font-weight: 500;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .article-title a {
    color: var(--text);
  }

  .article-title a:hover {
    color: var(--accent);
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.passed {
    background: rgba(42, 157, 110, 0.15);
    color: var(--green);
  }

  .status-badge.rejected {
    background: rgba(231, 76, 60, 0.15);
    color: var(--red);
  }

  .relevance-score {
    text-align: center;
    font-weight: 500;
  }

  .matched-keywords {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.85rem;
  }

  .filter-reason {
    max-width: 250px;
    font-size: 0.85rem;
    color: var(--dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .timestamp {
    color: var(--dim);
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .expand-row {
    cursor: pointer;
    user-select: none;
  }

  .expand-row:hover {
    background: var(--bg);
  }

  .expand-cell {
    text-align: center;
    padding: 0 !important;
    width: 40px;
  }

  .expand-icon {
    display: inline-block;
    transition: transform 0.2s;
    color: var(--dim);
  }

  .expand-row.expanded .expand-icon {
    transform: rotate(90deg);
  }

  .detail-row {
    display: none;
    background: var(--bg);
  }

  .detail-row.show {
    display: table-row;
  }

  .detail-cell {
    padding: 16px !important;
  }

  .detail-content {
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .detail-content h4 {
    margin-bottom: 8px;
    font-weight: 600;
  }

  .detail-content pre {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px;
    overflow-x: auto;
    font-size: 0.85rem;
    margin-top: 8px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--dim);
  }

  .empty-state svg {
    width: 64px;
    height: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
  }

  .pagination button {
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: 4px;
    cursor: pointer;
  }

  .pagination button:hover:not(:disabled) {
    background: var(--border);
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination .page-info {
    color: var(--dim);
    font-size: 0.9rem;
  }
</style>

<div class="logs-container">
  <div class="section-header">
    <h2>过滤日志</h2>
  </div>

  <div class="filters">
    <label>领域:</label>
    <select id="domainFilter" onchange="applyFilters()">
      <option value="">全部领域</option>
    </select>

    <label>结果:</label>
    <select id="resultFilter" onchange="applyFilters()">
      <option value="">全部</option>
      <option value="passed">通过</option>
      <option value="rejected">拒绝</option>
    </select>
  </div>

  <table class="logs-table" id="logsTable">
    <thead>
      <tr>
        <th class="expand-cell"></th>
        <th>文章标题</th>
        <th>领域</th>
        <th>结果</th>
        <th>相关性分数</th>
        <th>匹配关键词</th>
        <th>原因</th>
        <th>时间</th>
      </tr>
    </thead>
    <tbody id="logsBody">
      <!-- Dynamic content -->
    </tbody>
  </table>

  <div id="emptyState" class="empty-state" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <p>暂无过滤日志</p>
  </div>

  <div class="pagination" id="pagination" style="display: none;">
    <button id="prevBtn" onclick="prevPage()">上一页</button>
    <span class="page-info">第 <span id="currentPage">1</span> 页，共 <span id="totalPages">1</span> 页</span>
    <button id="nextBtn" onclick="nextPage()">下一页</button>
  </div>
</div>

<script>
let allLogs = [];
let filteredLogs = [];
let currentPage = 1;
const pageSize = 20;
let domains = [];

// Load data on page load
loadDomains();
loadLogs();

async function loadDomains() {
  try {
    const res = await fetch('/api/topic-domains?isActive=true');
    const data = await res.json();
    domains = data.domains || [];

    const select = document.getElementById('domainFilter');
    domains.forEach(domain => {
      const option = document.createElement('option');
      option.value = domain.id;
      option.textContent = domain.name;
      select.appendChild(option);
    });
  } catch (err) {
    console.error('Failed to load domains:', err);
  }
}

async function loadLogs() {
  try {
    const res = await fetch('/api/filter/logs');
    const data = await res.json();
    allLogs = data.logs || [];
    filteredLogs = [...allLogs];
    currentPage = 1;
    renderLogs();
  } catch (err) {
    console.error('Failed to load logs:', err);
    showEmptyState();
  }
}

function showEmptyState() {
  document.getElementById('logsTable').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('pagination').style.display = 'none';
}

function renderLogs() {
  const tbody = document.getElementById('logsBody');
  const emptyState = document.getElementById('emptyState');
  const table = document.getElementById('logsTable');
  const pagination = document.getElementById('pagination');

  if (filteredLogs.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    pagination.style.display = 'none';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  // Pagination
  const totalPages = Math.ceil(filteredLogs.length / pageSize);
  const startIdx = (currentPage - 1) * pageSize;
  const pageLogs = filteredLogs.slice(startIdx, startIdx + pageSize);

  tbody.innerHTML = pageLogs.map(log => {
    const domain = domains.find(d => d.id === log.domain_id);
    const matchedKeywords = log.matched_keywords ? JSON.parse(log.matched_keywords) : [];

    return \`
      <tr class="expand-row" data-id="\${log.id}">
        <td class="expand-cell"><span class="expand-icon">▶</span></td>
        <td class="article-title">
          <a href="#" title="\${escapeHtml(log.article_title || 'N/A')}">\${escapeHtml(log.article_title || 'N/A')}</a>
        </td>
        <td>\${domain ? escapeHtml(domain.name) : '-'}</td>
        <td>
          <span class="status-badge \${log.is_passed ? 'passed' : 'rejected'}">
            \${log.is_passed ? '通过' : '拒绝'}
          </span>
        </td>
        <td class="relevance-score">\${log.relevance_score !== null ? log.relevance_score.toFixed(2) : '-'}</td>
        <td class="matched-keywords" title="\${matchedKeywords.join(', ')}">\${matchedKeywords.join(', ') || '-'}</td>
        <td class="filter-reason" title="\${escapeHtml(log.filter_reason || '')}">\${escapeHtml(log.filter_reason || '-')}</td>
        <td class="timestamp">\${formatDate(log.created_at)}</td>
      </tr>
      <tr class="detail-row" id="detail-\${log.id}">
        <td colspan="8" class="detail-cell">
          <div class="detail-content">
            <h4>过滤详情</h4>
            <p><strong>文章ID:</strong> \${log.article_id}</p>
            <p><strong>领域:</strong> \${domain ? escapeHtml(domain.name) : '-'}</p>
            <p><strong>结果:</strong> \${log.is_passed ? '通过' : '拒绝'}</p>
            <p><strong>相关性分数:</strong> \${log.relevance_score !== null ? log.relevance_score.toFixed(2) : '-'}</p>
            <p><strong>匹配关键词:</strong> \${matchedKeywords.join(', ') || '-'}</p>
            <p><strong>原因:</strong> \${escapeHtml(log.filter_reason || '-')}</p>
            \${log.llm_response ? \`
              <h4 style="margin-top: 16px;">LLM 响应</h4>
              <pre>\${escapeHtml(log.llm_response)}</pre>
            \` : ''}
          </div>
        </td>
      </tr>
    \`;
  }).join('');

  // Update pagination
  document.getElementById('currentPage').textContent = currentPage;
  document.getElementById('totalPages').textContent = totalPages;
  document.getElementById('prevBtn').disabled = currentPage === 1;
  document.getElementById('nextBtn').disabled = currentPage === totalPages;
  pagination.style.display = 'flex';

  // Add click handlers for expand
  document.querySelectorAll('.expand-row').forEach(row => {
    row.addEventListener('click', function() {
      const id = this.dataset.id;
      this.classList.toggle('expanded');
      document.getElementById('detail-' + id).classList.toggle('show');
    });
  });
}

function applyFilters() {
  const domainFilter = document.getElementById('domainFilter').value;
  const resultFilter = document.getElementById('resultFilter').value;

  filteredLogs = allLogs.filter(log => {
    if (domainFilter && log.domain_id !== parseInt(domainFilter)) return false;
    if (resultFilter === 'passed' && !log.is_passed) return false;
    if (resultFilter === 'rejected' && log.is_passed) return false;
    return true;
  });

  currentPage = 1;
  renderLogs();
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderLogs();
  }
}

function nextPage() {
  const totalPages = Math.ceil(filteredLogs.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    renderLogs();
  }
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}
</script>
` }) %>
