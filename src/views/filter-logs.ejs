<div class="filters">
  <label>领域:</label>
  <select id="domainFilter" onchange="applyFilters()">
    <option value="">全部领域</option>
  </select>

  <label>结果:</label>
  <select id="resultFilter" onchange="applyFilters()">
    <option value="">全部</option>
    <option value="passed">通过</option>
    <option value="rejected">拒绝</option>
  </select>
</div>

<table class="logs-table" id="logsTable">
  <thead>
    <tr>
      <th class="expand-cell"></th>
      <th>文章标题</th>
      <th>领域</th>
      <th>结果</th>
      <th>相关性</th>
      <th>原因</th>
      <th>时间</th>
    </tr>
  </thead>
  <tbody id="logsBody">
    <!-- Dynamic content -->
  </tbody>
</table>

<div id="emptyState" class="empty-state" style="display: none;">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
  <p>暂无过滤日志</p>
</div>

<div class="pagination" id="pagination" style="display: none;">
</div>
</div>

<script>
  let currentPage = 1;
  let totalPages = 1;
  const pageSize = 20;
  let domains = [];
  let currentDomainFilter = '';
  let currentResultFilter = '';

  // Load data on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadDomains();
    loadLogs(1);
  });

  async function loadDomains() {
    try {
      const res = await fetch('/api/topic-domains?isActive=true');
      const data = await res.json();
      domains = data.domains || [];

      const select = document.getElementById('domainFilter');
      domains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain.id;
        option.textContent = domain.name;
        select.appendChild(option);
      });
    } catch (err) {
      console.error('Failed to load domains:', err);
      toast.error('加载领域列表失败: ' + (err.message || '网络错误'));
    }
  }

  async function loadLogs(page = 1) {
    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: pageSize.toString()
      });

      if (currentDomainFilter) {
        params.append('domainId', currentDomainFilter);
      }
      if (currentResultFilter) {
        params.append('isPassed', currentResultFilter === 'passed' ? 'true' : 'false');
      }

      const res = await fetch(\`/api/filter/logs?\${params}\`);
    const data = await res.json();

    currentPage = data.page || 1;
    totalPages = data.totalPages || 1;

    renderLogs(data.logs || [], data.total || 0);
  } catch (err) {
    console.error('Failed to load logs:', err);
    toast.error('加载日志失败: ' + (err.message || '网络错误'));
    showEmptyState();
  }
}

function showEmptyState() {
  document.getElementById('logsTable').style.display = 'none';
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('pagination').style.display = 'none';
}

function renderLogs(logs, total) {
  const tbody = document.getElementById('logsBody');
  const emptyState = document.getElementById('emptyState');
  const table = document.getElementById('logsTable');
  const pagination = document.getElementById('pagination');

  if (logs.length === 0) {
    table.style.display = 'none';
    emptyState.style.display = 'block';
    pagination.style.display = 'none';
    return;
  }

  table.style.display = 'table';
  emptyState.style.display = 'none';

  tbody.innerHTML = logs.map(log => {
    const domain = domains.find(d => d.id === log.domain_id);

    return \`
      <tr class="expand-row" data-id="\${log.id}">
        <td class="expand-cell"><span class="expand-icon">▶</span></td>
        <td class="article-title">
          <a href="#" title="\${escapeHtml(log.article_title || 'N/A')}">\${escapeHtml(log.article_title || 'N/A')}</a>
        </td>
        <td class="domain-cell" title="\${domain ? escapeHtml(domain.name) : '-'}">\${domain ? escapeHtml(domain.name) : '-'}</td>
        <td>
          <span class="status-badge \${log.is_passed ? 'passed' : 'rejected'}">
            \${log.is_passed ? '通过' : '拒绝'}
          </span>
        </td>
        <td class="relevance-score">\${log.relevance_score !== null ? log.relevance_score.toFixed(2) : '-'}</td>
        <td class="filter-reason" title="\${escapeHtml(log.filter_reason || '')}">\${escapeHtml(log.filter_reason || '-')}</td>
        <td class="timestamp">\${formatDate(log.created_at)}</td>
      </tr>
      <tr class="detail-row" id="detail-\${log.id}">
        <td colspan="7" class="detail-cell">
          <div class="detail-content">
            <h4>过滤详情</h4>
            <p><strong>文章ID:</strong> \${log.article_id}</p>
            <p><strong>领域:</strong> \${domain ? escapeHtml(domain.name) : '-'}</p>
            <p><strong>结果:</strong> \${log.is_passed ? '通过' : '拒绝'}</p>
            <p><strong>相关性分数:</strong> \${log.relevance_score !== null ? log.relevance_score.toFixed(2) : '-'}</p>
            <p><strong>原因:</strong> \${escapeHtml(log.filter_reason || '-')}</p>
            \${log.llm_response ? \`
              <h4 style="margin-top: 16px;">LLM 响应</h4>
              <pre>\${escapeHtml(log.llm_response)}</pre>
            \` : ''}
          </div>
        </td>
      </tr>
    \`;
  }).join('');

  // Render pagination
  renderPagination();

  // Add click handlers for expand
  document.querySelectorAll('.expand-row').forEach(row => {
    row.addEventListener('click', function() {
      const id = this.dataset.id;
      this.classList.toggle('expanded');
      document.getElementById('detail-' + id).classList.toggle('show');
    });
  });
}

function renderPagination() {
  const pagination = document.getElementById('pagination');

  if (totalPages <= 1) {
    pagination.style.display = 'none';
    return;
  }

  pagination.style.display = 'flex';

  let html = '';

  // Previous
  html += currentPage > 1
    ? \`<a href="#" onclick="goToPage(\${currentPage - 1}); return false;">← 上一页</a>\`
    : '<span>← 上一页</span>';

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += '<a href="#" onclick="goToPage(1); return false;">1</a>';
    if (startPage > 2) html += '<span>...</span>';
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += \`<span class="current">\${i}</span>\`;
    } else {
      html += \`<a href="#" onclick="goToPage(\${i}); return false;">\${i}</a>\`;
    }
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += \`<a href="#" onclick="goToPage(\${totalPages}); return false;">\${totalPages}</a>\`;
  }

  // Next
  html += currentPage < totalPages
    ? \`<a href="#" onclick="goToPage(\${currentPage + 1}); return false;">下一页 →</a>\`
    : '<span>下一页 →</span>';

  pagination.innerHTML = html;
}

function goToPage(page) {
  loadLogs(page);
}

function applyFilters() {
  currentDomainFilter = document.getElementById('domainFilter').value;
  currentResultFilter = document.getElementById('resultFilter').value;
  loadLogs(1);
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}
</script>
` }) %>