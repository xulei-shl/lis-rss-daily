<%- include('layout', { pageTitle: pageTitle, pageStyles: '<link rel="stylesheet" href="/css/pages/articles-list.css">'
  , body: ` <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">文章列表</h1>
    <div class="page-actions">
      <button class="btn btn-secondary" onclick="processBatch()">批量处理</button>
      <button class="btn btn-secondary" onclick="markAllAsRead()">批量已读</button>
    </div>
  </div>

  <!-- Filters Bar -->
  <div class="filters-bar">
    <!-- First Row: Source + Date Range -->
    <div class="filter-row filter-row-equal">
      <div class="filter-group">
        <span class="filter-label">来源</span>
        <select id="filterSource" class="filter-select">
          <option value="">全部来源</option>
        </select>
      </div>

      <div class="filter-group date-group">
        <span class="filter-label">爬取日期</span>
        <div class="date-range-group">
          <input type="date" id="dateFrom" class="filter-date" placeholder="起始日期" title="起始日期">
          <span class="date-separator">—</span>
          <input type="date" id="dateTo" class="filter-date" placeholder="结束日期" title="结束日期">
        </div>
      </div>
    </div>

    <!-- Second Row: Status, Process, Read, Search -->
    <div class="filter-row filter-row-equal">
      <div class="filter-group">
        <span class="filter-label">状态</span>
        <select id="filterStatus" class="filter-select">
          <option value="">全部状态</option>
          <option value="passed">通过</option>
          <option value="rejected">拒绝</option>
          <option value="pending">待处理</option>
        </select>
      </div>

      <div class="filter-group">
        <span class="filter-label">处理状态</span>
        <select id="filterProcess" class="filter-select">
          <option value="">全部</option>
          <option value="pending">待处理</option>
          <option value="processing">处理中</option>
          <option value="completed">已完成</option>
          <option value="failed">失败</option>
        </select>
      </div>

      <div class="filter-group">
        <span class="filter-label">已读</span>
        <select id="filterRead" class="filter-select">
          <option value="">全部</option>
          <option value="unread">未读</option>
          <option value="read">已读</option>
        </select>
      </div>

      <div class="filter-group search-group">
        <span class="filter-label">关键词</span>
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="searchInput" class="search-input" placeholder="搜索标题或摘要...">
        </div>
      </div>
    </div>
  </div>

  <!-- Results Count -->
  <div class="results-count" id="resultsCount"></div>

  <!-- Articles List -->
  <div id="articlesContainer">
    <div class="loading">加载中...</div>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination" style="display: none;"></div>

  <script>
    // ============================================
    // ARTICLES PAGE LOGIC
    // ============================================

    let currentPage = 1;
    let totalPages = 1;
    const perPage = 20;
    let rssSources = [];

    // Load on page ready
    document.addEventListener('DOMContentLoaded', () => {
      loadRSSSources();
      loadArticles();
      setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
      let searchTimeout;

      document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentPage = 1;
          loadArticles();
        }, 300);
      });

      ['filterSource', 'filterStatus', 'filterProcess', 'filterRead'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          currentPage = 1;
          loadArticles();
        });
      });

      ['dateFrom', 'dateTo'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          currentPage = 1;
          loadArticles();
        });
      });
    }

    // Load RSS sources for filter
    async function loadRSSSources() {
      try {
        const res = await fetch('/api/rss-sources');
        const data = await res.json();
        rssSources = data.sources || [];

        const select = document.getElementById('filterSource');
        rssSources.forEach(source => {
          const option = document.createElement('option');
          option.value = source.id;
          option.textContent = source.name;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to load RSS sources:', err);
      }
    }

    // Load articles
    async function loadArticles() {
      const container = document.getElementById('articlesContainer');
      container.innerHTML = '<div class="loading">加载中...</div>';

      const params = new URLSearchParams({
        page: currentPage,
        limit: perPage
      });

      // Add filters
      const sourceId = document.getElementById('filterSource').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const processStatus = document.getElementById('filterProcess').value;
      const filterRead = document.getElementById('filterRead').value;
      const searchQuery = document.getElementById('searchInput').value.trim();
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      // 日期范围优先于默认的 daysAgo
      const hasDateRange = dateFrom || dateTo;

      if (sourceId) params.append('rssSourceId', sourceId);
      if (filterStatus) params.append('filterStatus', filterStatus);
      if (processStatus) params.append('processStatus', processStatus);
      if (filterRead === 'read') params.append('isRead', 'true');
      if (filterRead === 'unread') params.append('isRead', 'false');
      if (searchQuery) params.append('search', searchQuery);
      if (dateFrom) params.append('createdAfter', dateFrom);
      if (dateTo) params.append('createdBefore', dateTo);
      // 只有在没有日期范围时才使用默认的30天过滤
      if (!hasDateRange) {
        params.append('daysAgo', '30');
      }

      try {
        const res = await fetch(\`/api/articles?\${params}\`);
    if (!res.ok) throw new Error('Failed to fetch');

    const data = await res.json();
    currentPage = data.page || 1;
    totalPages = data.totalPages || 1;

    renderArticles(data.articles || []);
    renderResultsCount(data.total || 0);
    renderPagination();
  } catch (err) {
    console.error('Failed to load articles:', err);
    container.innerHTML = \`
      <div class="empty-state">
        <div class="empty-state-title">加载失败</div>
        <div class="empty-state-desc">请稍后重试</div>
      </div>
    \`;
  }
}

// Render articles
function renderArticles(articles) {
  const container = document.getElementById('articlesContainer');

  if (articles.length === 0) {
    container.innerHTML = \`
      <div class="empty-state">
        <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <div class="empty-state-title">未找到文章</div>
        <div class="empty-state-desc">尝试调整筛选条件或搜索关键词</div>
      </div>
    \`;
    return;
  }

  container.innerHTML = articles.map((article, index) => renderArticleCard(article, index)).join('');
}

// Render single article card
function renderArticleCard(article, index) {
  const statusLabel = {
    'passed': '通过',
    'rejected': '拒绝',
    'pending': '待处理'
  };

  const processStatusLabel = {
    'pending': '待处理',
    'processing': '处理中',
    'completed': '已完成',
    'failed': '失败'
  };

  // 优先显示翻译摘要，否则显示 RSS 摘要
const summary = article.summary_zh || article.content || article.markdown_content?.substring(0, 300) || '';

  // 已读状态
  const isRead = article.is_read === 1;
  const isRejected = article.filter_status === 'rejected';
  const cardClass = isRead ? 'article-card fade-in-up is-read' : isRejected ? 'article-card fade-in-up is-rejected' : 'article-card fade-in-up';
  const readIcon = isRead ? '<span class="article-read-icon">✅</span>' : '';

  return \`
    <div class="\${cardClass}" style="animation-delay: \${index * 30}ms" data-article-id="\${article.id}">
      <div class="article-card-header">
        <h3 class="article-title">
          \${readIcon}<a href="/articles/\${article.id}">\${escapeHtml(article.title)}</a>
        </h3>
        <span class="badge \${article.filter_status}">\${statusLabel[article.filter_status] || '未知'}</span>
      </div>
      <div class="article-meta">
        <span>\${escapeHtml(article.rss_source_name || 'Unknown')}</span>
        <span class="article-meta-divider">·</span>
        <span>\${formatTime(article.published_at)}</span>
        <span class="article-meta-divider">·</span>
        <span>处理状态: \${processStatusLabel[article.process_status] || article.process_status}</span>
        <span class="article-meta-divider">·</span>
        <a href="\${escapeHtml(article.url)}" target="_blank" rel="noopener">原文</a>
      </div>
      \${summary ? \`<div class="article-summary">\${escapeHtml(truncate(summary, 200))}</div>\` : ''}
      <div class="article-footer">
        <div class="article-tags">
          \${article.tags ? article.tags.split(',').map(tag =>
            \`<span class="article-tag">#\${escapeHtml(tag.trim())}</span>\`
          ).join('') : ''}
        </div>
        <div class="article-actions">
          <button class="btn-icon" onclick="toggleReadStatus(\${article.id}, \${isRead})">
            \${isRead ? '未读' : '已读'}
          </button>
          \${article.process_status === 'pending' || article.process_status === 'failed'
            ? \`<button class="btn-icon" onclick="processArticle(\${article.id})">处理</button>\`
            : ''
          }
          <button class="btn-icon" onclick="deleteArticle(\${article.id})">删除</button>
        </div>
      </div>
    </div>
  \`;
}

// Render results count
function renderResultsCount(total) {
  const countEl = document.getElementById('resultsCount');
  const start = (currentPage - 1) * perPage + 1;
  const end = Math.min(currentPage * perPage, total);
  countEl.textContent = total > 0
    ? \`显示 \${start}-\${end} / 共 \${total} 篇文章\`
    : '暂无文章';
}

// Render pagination
function renderPagination() {
  const pagination = document.getElementById('pagination');

  if (totalPages <= 1) {
    pagination.style.display = 'none';
    return;
  }

  pagination.style.display = 'flex';

  let html = '';

  // Previous
  html += currentPage > 1
    ? \`<a href="#" onclick="goToPage(\${currentPage - 1}); return false;">← 上一页</a>\`
    : '<span>← 上一页</span>';

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += '<a href="#" onclick="goToPage(1); return false;">1</a>';
    if (startPage > 2) html += '<span>...</span>';
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += \`<span class="current">\${i}</span>\`;
    } else {
      html += \`<a href="#" onclick="goToPage(\${i}); return false;">\${i}</a>\`;
    }
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) html += '<span>...</span>';
    html += \`<a href="#" onclick="goToPage(\${totalPages}); return false;">\${totalPages}</a>\`;
  }

  // Next
  html += currentPage < totalPages
    ? \`<a href="#" onclick="goToPage(\${currentPage + 1}); return false;">下一页 →</a>\`
    : '<span>下一页 →</span>';

  pagination.innerHTML = html;
}

// Go to page
function goToPage(page) {
  currentPage = page;
  loadArticles();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Process single article
async function processArticle(id) {
  try {
    const res = await fetch(\`/api/articles/\${id}/process\`, { method: 'POST' });
    const result = await res.json();

    if (res.ok) {
      await showConfirm('处理任务已加入队列', {
        title: '成功',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
      loadArticles();
    } else {
      await showConfirm(result.error || '操作失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('操作失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}

// Process batch articles
async function processBatch() {
  const confirmed = await showConfirm('确定要将所有待处理文章加入处理队列吗？', {
    title: '批量处理',
    okText: '确认处理',
    cancelText: '取消'
  });
  if (!confirmed) return;

  try {
    const res = await fetch('/api/articles/process-batch', { method: 'POST' });
    const result = await res.json();

    if (res.ok) {
      await showConfirm(\`已将 \${result.count || 0} 篇文章加入处理队列\`, {
        title: '批量处理',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
      loadArticles();
    } else {
      await showConfirm(result.error || '操作失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('操作失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}

// Delete article
async function deleteArticle(id) {
  const confirmed = await showConfirm('确定要删除这篇文章吗？', {
    title: '删除文章',
    okText: '删除',
    cancelText: '取消'
  });
  if (!confirmed) return;

  try {
    const res = await fetch(\`/api/articles/\${id}\`, { method: 'DELETE' });

    if (res.ok) {
      loadArticles();
    } else {
      const result = await res.json();
      await showConfirm(result.error || '删除失败', {
        title: '错误',
        okText: '知道了',
        okButtonType: 'btn-secondary'
      });
    }
  } catch (err) {
    await showConfirm('删除失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}

// Utility functions
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function truncate(str, len) {
  if (!str) return '';
  if (str.length <= len) return str;
  return str.substring(0, len - 3) + '...';
}

function formatTime(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;

  if (diff < 60000) return '刚刚';
  if (diff < 3600000) return \`\${Math.floor(diff / 60000)} 分钟前\`;
  if (diff < 86400000) return \`\${Math.floor(diff / 3600000)} 小时前\`;

  return date.toLocaleDateString('zh-CN', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Toggle article read status
async function toggleReadStatus(articleId, currentIsRead) {
  try {
    const res = await fetch(\`/api/articles/\${articleId}/read\`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_read: !currentIsRead })
    });

    if (!res.ok) throw new Error('Failed to update');

    loadArticles();
  } catch (err) {
    console.error('Failed to toggle read status:', err);
    alert('操作失败，请稍后重试');
  }
}

// Mark all articles as read
async function markAllAsRead() {
  // 如果当前筛选的是已读文章，提示用户
  const filterRead = document.getElementById('filterRead').value;
  if (filterRead === 'read') {
    await showConfirm('当前筛选的是已读文章，没有需要标记的文章', {
      title: '提示',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
    return;
  }

  const confirmed = await showConfirm('确定要将当前筛选结果中的所有未读文章标记为已读吗？', {
    title: '批量已读',
    okText: '确认',
    cancelText: '取消'
  });
  if (!confirmed) return;

  try {
    // 获取当前筛选条件
    const sourceId = document.getElementById('filterSource').value;
    const filterStatus = document.getElementById('filterStatus').value;
    const processStatus = document.getElementById('filterProcess').value;
    const searchQuery = document.getElementById('searchInput').value.trim();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    const body = { filterStatus: 'passed', daysAgo: 30 };
    if (sourceId) body.rssSourceId = sourceId;
    if (filterStatus) body.filterStatus = filterStatus;
    if (processStatus) body.processStatus = processStatus;
    // 已读筛选：如果是"全部"或"未读"，则批量标记未读文章
    if (filterRead === 'unread') body.isRead = false;
    if (searchQuery) body.search = searchQuery;
    if (dateFrom) body.createdAfter = dateFrom;
    if (dateTo) body.createdBefore = dateTo;
    if (!dateFrom && !dateTo) body.daysAgo = 30;

    const res = await fetch('/api/articles/mark-all-read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) throw new Error('Failed to mark all as read');

    const result = await res.json();
    await showConfirm(\`已将 \${result.count || 0} 篇文章标记为已读\`, {
      title: '批量已读',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });

    loadArticles();
  } catch (err) {
    console.error('Failed to mark all as read:', err);
    await showConfirm('操作失败，请稍后重试', {
      title: '错误',
      okText: '知道了',
      okButtonType: 'btn-secondary'
    });
  }
}
  </script>
  ` }) %>