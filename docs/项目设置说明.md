# 项目设置说明

## 配置体系设计

本项目采用**分层兜底配置**设计，数据库配置与环境变量配置各司其职，不是冗余或冲突。

### 配置获取优先级

```
数据库配置 (llm_configs 表)
      ↓ 如果不存在或失败
环境变量配置 (.env 文件)
```

### 两层配置的职责划分

| 层级 | 数据库配置 (.db) | 环境变量配置 (.env) |
|------|-----------------|-------------------|
| **用途** | 用户业务配置 | 系统基础设施配置 |
| **特点** | 动态、可修改、多租户 | 静态、启动时加载 |
| **管理方式** | Web 设置页 | 手动编辑文件 |
| **示例** | API Key、Model、BaseURL | Port、DB路径、JWT Secret |
| **安全性** | API Key 加密存储 | 系统级密钥 |

### 数据库配置表

| 表名 | 用途 | 接入状态 |
|------|------|---------|
| `rss_sources` | RSS 订阅源 | ✅ 已接入 |
| `llm_configs` | LLM/Embedding/Rerank 配置 | ✅ 已接入 |
| `system_prompts` | 系统提示词 | ✅ 已接入（运行时优先读取模板，缺失时回退硬编码/动态拼装） |

### 环境变量说明

#### LLM 相关（兜底配置）
当数据库中无 LLM 配置时使用：
- `LLM_PROVIDER` - LLM 提供商 (openai/gemini)
- `OPENAI_API_KEY` / `GEMINI_API_KEY` - API 密钥
- `OPENAI_BASE_URL` / `OPENAI_DEFAULT_MODEL` - OpenAI 配置
- `GEMINI_MODEL` - Gemini 模型

#### 系统基础配置
- `PORT` - 服务器端口 (默认 3000)
- `BASE_URL` - 基础 URL
- `DATABASE_PATH` - 数据库路径
- `JWT_SECRET` / `JWT_EXPIRES_IN` - JWT 认证配置

#### 安全配置
- `LLM_ENCRYPTION_KEY` - LLM API Key 加密密钥（必须 64 字符十六进制）

#### 行为配置
- `RSS_FETCH_SCHEDULE` - RSS 定时任务 cron 表达式
- `RSS_FETCH_ENABLED` - 是否启用 RSS 定时抓取
- `RSS_MAX_CONCURRENT` - RSS 最大并发数
- `RSS_FETCH_TIMEOUT` - RSS 请求超时时间
- `LOG_LEVEL` - 日志级别
- `LOG_FILE` - 日志文件路径

### 代码实现

**LLM 配置获取逻辑** ([src/llm.ts:202-239](src/llm.ts#L202-L239))：

```typescript
// 优先使用数据库配置
export async function getUserLLMProvider(userId: number): Promise<LLMProvider> {
  const dbConfig = await getActiveLLMConfig(userId);

  if (!dbConfig) {
    log.warn({ userId }, 'No LLM config found for user, falling back to environment');
    return getLLM();  // 降级到环境变量
  }
  // 使用数据库配置...
}

// 环境变量兜底
export function getLLM(): LLMProvider {
  if (_envProvider) return _envProvider;
  _envProvider = createProviderFromEnv();
  return _envProvider;
}
```

**系统提示词获取与兜底逻辑**：

- **运行时优先使用 `system_prompts`**（按类型读取启用模板并渲染变量）
  - `summary/keywords/translation`：`src/agent.ts`
  - `filter`：`src/filter.ts`
- **兜底策略**：当对应类型模板不存在或为空时
  - `summary/keywords/translation` 回退内置提示词
  - `filter` 回退为 `topic_domains` + `topic_keywords` 动态拼装
- **初始化默认模板**：
  - `POST /api/system-prompts/bootstrap` 会在缺失时补齐 `filter/summary/keywords/translation` 四类模板并启用
  - 设置页提供“一键初始化默认模板”按钮

### 设计理念

1. **用户业务配置数据库化**：用户可通过设置页动态修改，支持多租户
2. **系统基础配置环境变量化**：启动时必须的固定参数
3. **降级兜底保证健壮性**：数据库配置失败时仍可通过环境变量运行

### 总结

当前配置设计符合最佳实践：
- 数据库配置是**主力**
- 环境变量是**备用 + 系统基础**
- 两者是**分层兜底关系**，不是冗余冲突
