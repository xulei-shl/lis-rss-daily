# 语义检索重构方案

## 目标

- 完全移除 QMD，本地语义检索改为在线向量大模型 + 本地 Chroma。
- 向量化与语义检索模块独立、可复用，供搜索页与相关文章统一调用。
- 模型与参数不硬编码，全部存数据库配置。
- 使用单集合 `articles`，全文向量（title + summary + content）。
- 相关文章检索必须能映射回原始文章 `id` 用于页面展示。

## 关键约束

- 彻底重构，不考虑向后兼容。
- KISS/DRY/单一职责/高内聚低耦合。
- Chroma 本地，单集合，默认不启用 rerank，需配置且启用才使用。

## 数据库设计

### 1) 扩展 `llm_configs`

新增字段：

- `config_type TEXT NOT NULL DEFAULT 'llm'`
  - 取值：`llm`、`embedding`、`rerank`
- `enabled INTEGER DEFAULT 0`（rerank 开关）

迁移策略：

- 现有记录全部设置为 `llm`。
- 后续所有查询必须按 `config_type` 过滤。

### 2) `settings` 新增键

- `chroma_host`（默认 `127.0.0.1`）
- `chroma_port`（默认 `8000`）
- `chroma_collection`（默认 `articles`）
- `chroma_distance_metric`（默认 `cosine`）

## 模块划分与职责

### 1) `src/vector/embedding-client.ts`

职责：

- OpenAI 兼容 Embedding 调用（硅基流动）。
- 支持超时/重试/批量。
- 通过 `llm_configs` 获取 `embedding` 配置。

核心接口：

- `getEmbedding(text: string): Promise<number[]>`
- `getEmbeddingsBatch(texts: string[]): Promise<number[][]>`

### 2) `src/vector/vector-store.ts`

职责：

- Chroma 本地存储管理。
- 建立 collection（固定 `articles`）。
- 写入/删除/检索向量。

核心接口：

- `upsert(ids: string[], embeddings: number[][], metadatas: object[], documents: string[]): Promise<void>`
- `query(embedding: number[], topK: number, filter?: object): Promise<VectorHit[]>`
- `delete(ids: string[]): Promise<void>`

### 3) `src/vector/reranker.ts`

职责：

- 硅基流动 rerank 接口封装。
- 只有 `rerank` 配置且 `enabled=true` 才触发。

核心接口：

- `rerank(query: string, documents: string[], topN?: number): Promise<Array<{ index: number; score: number }>>`

### 4) `src/vector/indexer.ts`

职责：

- 向量化索引队列，串行化写入避免并发冲突。
- 负责单篇/批量索引与删除。
- 按 `user_id` 分组写入，避免跨用户混写。

核心接口：

- `indexArticle(articleId: number): Promise<void>`
- `indexArticles(articleIds: number[]): Promise<void>`
- `deleteArticle(articleId: number): Promise<void>`

### 5) `src/vector/search.ts`

职责：

- 统一语义检索入口。
- 输出必须包含 `articleId` 以回查原文。

核心接口：

- `semanticSearch(query: string, limit: number, userId: number): Promise<Array<{ articleId: number; score: number }>>`
- `relatedByArticle(articleId: number, limit: number, userId: number): Promise<Array<{ articleId: number; score: number }>>`

## 向量化内容策略（全文）

拼接文本：

```
TITLE: {title}
SUMMARY: {summary}
CONTENT: {content}
```

- `summary` 为空则忽略。
- 统一在索引时构建，避免重复逻辑。

## 语义检索流程

### 1) 搜索页

- 输入 `query` → embedding → Chroma 检索 → 返回 `articleId + score`。
- 再查数据库补全标题/摘要/来源/发布时间。
- 若启用 rerank：
  - 以 `query` 为 anchor，对候选文档进行重排序。
  - 仅调整排序，不改变候选集合。

### 2) 相关文章

- 输入 `articleId` → 读取文章正文 → embedding → Chroma 检索。
- 过滤掉自身 `articleId`。
- 回查文章详情并返回 `id`，确保页面可直接跳转。

## 搜索接口调整

### 1) `GET /api/search`

- `mode=semantic`：仅向量检索
- `mode=keyword`：仅 SQLite LIKE
- `mode=mixed`：向量 + 关键词融合

混合策略：

- 语义分数归一化后与关键词相关度线性融合。
- 权重默认 0.7(语义)/0.3(关键词)。
- 混合结果复用 `relevance` 字段输出综合分。

### 2) `GET /api/articles/:id/related`

- 统一走向量检索 + 关键词重合融合。
- 缓存写回 `article_related`。

## 移除 QMD

- 删除 `src/qmd.ts` 及所有调用。
- 删除 `qmd` 相关配置、监听、索引队列。
- 搜索与相关文章逻辑完全切换到向量模块。
- 文档中移除 QMD 相关说明。

## 设置页改造

### LLM 配置复用

- 新增 `config_type` 选择：`llm` / `embedding` / `rerank`。
- `embedding` 与 `rerank` 使用与 LLM 相同的表单字段：
  - provider/base_url/api_key/model/timeout/max_retries
- rerank 额外字段：`enabled`（布尔）。

### Chroma 设置

- 单独在设置页新增 Chroma 区域：
  - host/port/collection/distance_metric
- 保存到 `settings` 表。

## 索引时机

- 文章导出完成后触发索引。
- 文章删除时同步删除向量。
- 批量处理/重试完成后可批量索引。

## 详细改动清单

### 数据库

- `llm_configs` 增加 `config_type` 字段
- `llm_configs` 增加 `enabled` 字段（rerank）
- `settings` 增加 Chroma 相关 key
- 新增迁移脚本：`sql/002_vector_refactor.sql`

### 后端

- 新增 `src/vector/*` 模块
- `src/search.ts`：替换 QMD 逻辑为向量检索
- `src/api/routes/search.routes.ts`：替换语义检索入口
- `src/api/articles.ts`：替换相关文章逻辑
- `src/pipeline.ts`：导出后触发向量索引
- `src/api/routes/settings.routes.ts`：新增 Chroma 配置接口
- `src/api/settings.ts`：新增 Chroma 读写方法
- 移除 QMD 相关文件与初始化逻辑

### 前端

- `src/views/settings.ejs`：新增配置表单与逻辑
- 复用现有 LLM 配置管理接口
- LLM 配置支持 `config_type` 与 rerank 开关

## 实施结果（已完成）

### 关键实现

- 向量模块：`src/vector/embedding-client.ts`、`vector-store.ts`、`reranker.ts`、`indexer.ts`、`search.ts`、`text-builder.ts`
- 语义搜索入口：`src/api/routes/search.routes.ts`（支持 semantic/keyword/mixed）
- 相关文章入口：`src/api/articles.ts`（向量 + 关键词融合）
- 索引触发：`src/pipeline.ts`（导出后非阻塞索引）
- 设置页与 API：`src/views/settings.ejs`、`src/api/routes/settings.routes.ts`
- 数据库迁移：`sql/001_init.sql`、`sql/002_vector_refactor.sql`、`scripts/migrate.ts`

### 已移除

- `src/qmd.ts` 及其初始化/索引/监听逻辑
- `.env.example` 与启动脚本中的 QMD 配置项
- `Dockerfile`、`docker-compose.yml` 中 QMD 相关目录与环境变量

### 依赖调整

- 新增 `chromadb` 依赖（`package.json`、`pnpm-lock.yaml`）

## 风险与处理

- Chroma 未启动：
  - 向量检索直接失败，接口返回空结果并记录日志。
- Embedding 配置缺失：
  - 向量化/检索失败，提示配置缺失。
- rerank 配置缺失：
  - 自动跳过重排。

## 实施顺序

1) 数据库迁移：新增 `config_type` + Chroma settings
2) 向量模块（embedding/vector-store/reranker/indexer/search）
3) 搜索与相关文章切换
4) 设置页配置支持
5) 删除 QMD 及相关文档
